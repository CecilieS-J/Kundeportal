
{% extends 'layout.html' %}

{% block content %}
  <h2>Sammenlign kundedata</h2>

  {# Flash-beskeder #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="get"
        action="{{ url_for('comparison.compare') }}"
        class="mb-4">

    <div class="form-group mb-3">
      <label for="identifier" class="form-label">
        E-mail, kundenummer eller Goodiecard
      </label>
      <input
        type="text"
        id="identifier"
        name="identifier"
        class="form-control"
        placeholder="Indtast e-mail, kundenummer eller Goodiecard"
        value="{{ request.args.get('identifier','') }}"
        required
      >
    </div>

    <div class="form-group mb-3">
      <label for="identifier_type" class="form-label">
        Identifikator type
      </label>
      <select
        id="identifier_type"
        name="identifier_type"
        class="form-control"
        required
      >
        <option value="email"
          {% if request.args.get('identifier_type') == 'email' %}selected{% endif %}>
          E-mail
        </option>
        <option value="customer_no"
          {% if request.args.get('identifier_type') == 'customer_no' %}selected{% endif %}>
          Kundenummer
        </option>
        <option value="goodiecard"
          {% if request.args.get('identifier_type') == 'goodiecard' %}selected{% endif %}>
          Goodiecard
        </option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary">SÃ¸g</button>
  </form>

  {% if data %}
    {% if data %}
  <h3>Resultater for {{ data.identifier }} ({{ data.identifier_type }})</h3>

  {# Oversigt over hvilke systemer der fandtes data i #}
  <h4>Fundet i</h4>
  <ul>
    {% for system in ['Brevo', 'External', 'Omneo', 'SFCC'] %}
      {% if system not in data.not_found %}
        <li>{{ system }}</li>
      {% endif %}
    {% endfor %}
    {% if not data.not_found %}
      <li>Alle systemer</li>
    {% endif %}
  </ul>

  {# Tabel med alle data kombineret pr. felt #}
  <h4>Alle data</h4>
  <table class="table table-sm">
    <thead>
      <tr>
        <th>Felt</th>
        {% for system in ['Brevo','External','Omneo','SFCC'] %}
          <th>{{ system }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for field, values in data.all_data.items() %}
        <tr>
          <td>{{ field }}</td>
          {% for system in ['Brevo','External','Omneo','SFCC'] %}
            <td>{{ values[system] or '-' }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {# Liste over felter med uoverensstemmelser #}
  <h4>Forskelle</h4>
  {% if data.differences %}
    <ul>
      {% for field, vals in data.differences.items() %}
        <li>
          <strong>{{ field }}</strong>:
          {% for system, val in vals.items() %}
            {{ system }}="{{ val }}"{% if not loop.last %}, {% endif %}
          {% endfor %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Ingen forskelle fundet.</p>
  {% endif %}

  {# Eventuelt din Chart.js-konfiguration #}
  <canvas id="syncChart"></canvas>
  <script>
    const cfg = {{ chart_config|tojson }};
    const ctx = document.getElementById('syncChart').getContext('2d');
    new Chart(ctx, cfg);
  </script>
{% endif %}

  {% endif %}
{% endblock %}