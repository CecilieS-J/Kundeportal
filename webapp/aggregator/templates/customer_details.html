{% extends 'layout.html' %}

{% block title %}Resultater{% endblock %}

{% block content %}
<div class="container mt-4">
  {%- set search_val = external.get('goodiecard') or '-' -%}
<h2>Resultater for Goodiecard {{ search_val }}</h2>

  <!-- Fundet i -->
  <h4>Fundet i</h4>
  <ul>
    {% if brevo %}<li>Brevo</li>{% endif %}
    {% if external %}<li>External</li>{% endif %}
    {% if sfcc %}<li>SFCC</li>{% endif %}
    {% if not brevo and not external and not sfcc %}<li>Ingen systemer</li>{% endif %}
  </ul>

  <!-- Alle data -->
  {% set unsupported = {
    'brevo': ['omneo_id', 'birthday'],
    'sfcc': ['sib_id', 'phone_mobile', 'omneo_id', 'birthday'],
    'external': []
  } %}
  <h4>Alle data</h4>
  <div class="table-responsive">
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>Felt</th>
          <th>Brevo</th>
          <th>External</th>
          <th>SFCC</th>
        </tr>
      </thead>
      <tbody>
        {# Exclude data_pretty #}
        {%- set keys = external.keys()|select('ne','data_pretty')|list -%}
        {%- for system in ['brevo','sfcc'] -%}
          {%- for key in (system == 'brevo' and brevo or sfcc).keys() if key not in keys -%}
            {%- set _ = keys.append(key) -%}
          {%- endfor -%}
        {%- endfor -%}

        {% for key in keys %}
        <tr>
          <td>{{ key|replace('_',' ')|title }}</td>
          <td>
            {% if key in unsupported['brevo'] %}
              <span class="text-muted">Ikke tilgængelig</span>
            {% else %}
              {{ brevo.get(key, '–') }}
            {% endif %}
          </td>
          <td>{{ external.get(key, '–') }}</td>
          <td>
            {% if key in unsupported['sfcc'] %}
              <span class="text-muted">Ikke tilgængelig</span>
            {% else %}
              {{ sfcc.get(key, '–') }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Forskelle -->
  <h4>Forskelle</h4>
  {% set diffs = [] %}
  {% for key in keys %}
    {# Saml værdier fra understøttede systemer #}
    {% set vals = [] %}
    {% if key not in unsupported['brevo'] %}
      {% set val = brevo.get(key) %}
      {% set _ = vals.append(val) %}
    {% endif %}
    {% if key not in unsupported['external'] %}
      {% set val = external.get(key) %}
      {% set _ = vals.append(val) %}
    {% endif %}
    {% if key not in unsupported['sfcc'] %}
      {% set val = sfcc.get(key) %}
      {% set _ = vals.append(val) %}
    {% endif %}
    {# Find unikke værdier inklusive None og '' #}
    {% set uniq = [] %}
    {% for v in vals %}
      {% set vstr = v is none and '' or (v|string) %}
      {% if vstr not in uniq %}
        {% set _ = uniq.append(vstr) %}
      {% endif %}
    {% endfor %}
    {# Diff hvis mere end ét unikt element, hvor unikt element != '' #}
    {% if uniq|length > 1 %}
      {% set diffs = diffs + [{
        'field': key,
        'brevo': key in unsupported['brevo'] and '–' or (brevo.get(key) is none and '' or (brevo.get(key)|string)),
        'external': external.get(key) is none and '' or (external.get(key)|string),
        'sfcc': key in unsupported['sfcc'] and '–' or (sfcc.get(key) is none and '' or (sfcc.get(key)|string))
      }] %}
    {% endif %}
  {% endfor %}

  {% if diffs %}
    <ul>
    {% for d in diffs %}
      <li><strong>{{ d.field|replace('_',' ')|title }}</strong>: Brevo="{{ d.brevo }}", External="{{ d.external }}", SFCC="{{ d.sfcc }}"</li>
    {% endfor %}
    </ul>
  {% else %}
    <p>Ingen forskelle fundet.</p>
  {% endif %}
</div>
<a href="{{ url_for('aggregator.customer_form') }}" class="btn btn-secondary">
    Tilbage
  </a>
{% endblock %}