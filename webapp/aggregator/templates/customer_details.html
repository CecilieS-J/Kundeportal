{% extends 'layout.html' %}

{% block title %}Resultater{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Resultater for {{ request.args.get(request.args.get('identifier_type') or 'query') }} ({{ request.args.get('identifier_type')|replace('_',' ')|title }})</h2>

  <!-- Fundet i -->
  <h4>Fundet i</h4>
  <ul>
    {% if brevo %}<li>Brevo</li>{% endif %}
    {% if external %}<li>External</li>{% endif %}
    {% if sfcc %}<li>SFCC</li>{% endif %}
    {% if not brevo and not external and not sfcc %}<li>Ingen systemer</li>{% endif %}
  </ul>

  <!-- Alle data -->
  {% set sfcc_unsupported = ['sib_id', 'phone_mobile', 'omneo_id', 'birthday'] %}
  {% set brevo_unsupported = ['omneo_id', 'birthday'] %}
  <h4>Alle data</h4>
  <div class="table-responsive">
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>Felt</th>
          <th>Brevo</th>
          <th>External</th>
          <th>SFCC</th>
        </tr>
      </thead>
      <tbody>
        {# Exclude data_pretty #}
        {%- set keys = external.keys()|select('ne','data_pretty')|list -%}
        {%- for key in sfcc.keys() if key not in keys -%}
          {%- set _ = keys.append(key) -%}
        {%- endfor -%}
        {%- for key in brevo.keys() if key not in keys -%}
          {%- set _ = keys.append(key) -%}
        {%- endfor -%}

        {% for key in keys %}
        <tr>
          <td>{{ key|replace('_',' ')|title }}</td>
          <td>
            {% if brevo.get(key) is none and key in brevo_unsupported %}
              <span class="text-muted">Ikke tilgængelig</span>
            {% else %}
              {{ brevo.get(key, '-') }}
            {% endif %}
          </td>
          <td>{{ external.get(key, '-') }}</td>
          <td>
            {% if sfcc.get(key) is none and key in sfcc_unsupported %}
              <span class="text-muted">Ikke tilgængelig</span>
            {% else %}
              {{ sfcc.get(key, '-') }}
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Forskelle -->
  <h4>Forskelle</h4>
  {%- set diffs = [] -%}
  {% for key in keys %}
    {%- set e = external.get(key)|string -%}
    {%- set b_val = brevo.get(key) -%}
    {%- set b = b_val is none and key in brevo_unsupported and 'Ikke tilgængelig' or (b_val|string) -%}
    {%- set s_val = sfcc.get(key) -%}
    {%- set s = s_val is none and key in sfcc_unsupported and 'Ikke tilgængelig' or (s_val|string) -%}
    {# Kun hvis der er nogen reel forskel blandt de tilgængelige #}
    {% if (e != b or e != s or b != s) and not (e == '-' and b == '-' and s == '-') %}
      {%- set _ = diffs.append({'field': key, 'brevo': b, 'external': e, 'sfcc': s}) -%}
    {% endif %}
  {% endfor %}

  {% if diffs %}
  <ul>
    {% for d in diffs %}
    <li><strong>{{ d.field|replace('_',' ')|title }}</strong>:
        Brevo="{{ d.brevo }}", External="{{ d.external }}", SFCC="{{ d.sfcc }}"
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>Ingen forskelle fundet.</p>
  {% endif %}
</div>
{% endblock %}